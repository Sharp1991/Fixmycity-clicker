<!DOCTYPE html>
<html>
<head>
    <title>GPS Tracker</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            text-align: center; 
            padding: 50px;
            background: #f5f5f5;
        }
        #status {
            font-size: 20px;
            margin: 30px;
            padding: 20px;
            border-radius: 10px;
            background: #fff3cd;
            color: #856404;
            border: 2px solid #ffeaa7;
        }
        button {
            font-size: 20px;
            padding: 20px 40px;
            margin: 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            background: #007bff;
            color: white;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .success { background: #d4edda; color: #155724; border-color: #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border-color: #f5c6cb; }
    </style>
</head>
<body>
    <h1>üìç GPS Location Tracker</h1>
    <div id="status">Click "Get Location" to start</div>
    
    <button id="getLocationBtn">Get Location</button>
    <button id="sendDataBtn" disabled>Send to Database</button>

    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

        // Supabase setup
        const SUPABASE_URL = 'https://kdjwrgcyhtrxfjvhonfh.supabase.co'
        const SUPABASE_KEY = 'sb_publishable_SqTmlMsLjOXafXiv1vwxcg_--j67cTK'
        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY)

        const statusEl = document.getElementById('status')
        const getLocationBtn = document.getElementById('getLocationBtn')
        const sendDataBtn = document.getElementById('sendDataBtn')

        let currentLocation = null

        // Simple status update
        function updateStatus(message, type = '') {
            statusEl.textContent = message
            statusEl.className = type
            console.log('Status:', message)
        }

        // 1. GET LOCATION - Manual trigger
        getLocationBtn.addEventListener('click', () => {
            updateStatus('üîÑ Getting your location...')
            
            if (!navigator.geolocation) {
                updateStatus('‚ùå Geolocation not supported', 'error')
                return
            }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    currentLocation = {
                        lat: position.coords.latitude,
                        lon: position.coords.longitude,
                        accuracy: position.coords.accuracy
                    }
                    
                    updateStatus(
                        `‚úÖ Location acquired! 
                        Lat: ${currentLocation.lat.toFixed(6)}
                        Lon: ${currentLocation.lon.toFixed(6)}
                        Accuracy: ¬±${currentLocation.accuracy.toFixed(1)}m`,
                        'success'
                    )
                    
                    sendDataBtn.disabled = false
                    sendDataBtn.style.background = '#28a745'
                },
                (error) => {
                    let errorMessage = '‚ùå Failed to get location: '
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage += 'Permission denied. Please allow location access.'
                            break
                        case error.POSITION_UNAVAILABLE:
                            errorMessage += 'Location unavailable.'
                            break
                        case error.TIMEOUT:
                            errorMessage += 'Request timed out.'
                            break
                        default:
                            errorMessage += 'Unknown error.'
                    }
                    updateStatus(errorMessage, 'error')
                    currentLocation = null
                    sendDataBtn.disabled = true
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            )
        })

        // 2. SEND DATA - Simple insert
        sendDataBtn.addEventListener('click', async () => {
            if (!currentLocation) {
                updateStatus('‚ùå No location data available', 'error')
                return
            }

            updateStatus('üì° Sending to database...')
            sendDataBtn.disabled = true

            try {
                const { error } = await supabase
                    .from('road_clicks')
                    .insert([
                        {
                            lat: currentLocation.lat,
                            lon: currentLocation.lon,
                            created_at: new Date().toISOString()
                        }
                    ])

                if (error) {
                    throw error
                }

                updateStatus('‚úÖ Data successfully sent to database!', 'success')
                
                // Reset after success
                setTimeout(() => {
                    currentLocation = null
                    sendDataBtn.disabled = true
                    sendDataBtn.style.background = '#6c757d'
                    updateStatus('Click "Get Location" to send another point')
                }, 3000)

            } catch (error) {
                console.error('Database error:', error)
                updateStatus(`‚ùå Failed to send: ${error.message}`, 'error')
                sendDataBtn.disabled = false
                sendDataBtn.style.background = '#28a745'
            }
        })

        // Test connection on load
        updateStatus('‚úÖ Page loaded - Click "Get Location" to start')
        console.log('Page loaded successfully')
    </script>
</body>
</html>
